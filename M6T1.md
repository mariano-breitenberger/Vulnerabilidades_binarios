# **Metodología de análisis de vulnerabilidades y explotación**

En este trabajo nos adentraremos inicialmente en como generar un ambiente para poder explotar vulnerabilidades en archivos binarios. Como es una introducción, comenzaremos con el "setup" o instalación de las herramientas necesarios y luego utilizaremos una máquina o servidor que contiene el binario con ciertas vulnerabilidades. Si bien, es posible que este tipo de vulnerabilidades no se encuentren en un ambiente productivo, si es importante comenzar por lo básico para poder ir ganando experiencia y luego si poder dar el salto hacia casos de mayor complejidad.

Por otro lado, considero importante dar una pequeña descripción de dos palabras que seguramente utilizaremos más adelante pero que sería bueno definirlas de manera temprana para poder estar en una misma página.

<ins>Fuzzing:</ins> como podemos ver en el manual, voy a citar textual, *"el fuzzing es una técnica que consiste en proporcionar entradas masivas y generalmente aleatorias a un programa o componente, con el objetivo de detectar fallos inesperados. La idea detrás del fuzzing es simple pero poderosa: si se inyectan suficientes datos, tarde o temprano se activará algún comportamiento no previsto por el desarrollador, y eso podría revelar la existencia de una vulnerabilidad"*.

<ins>Ingeniería inversa</ins>: como podemos ver en el manual, voy a citar textual, *"La ingeniería inversa, en el ámbito de la ciberseguridad, consiste en descomponer y analizar el comportamiento interno de un software, elemento o sistema con el fin de
comprender su lógica, descubrir errores de diseño o implementación, identificar posibles vulnerabilidades, e incluso manipular su comportamiento. Su uso es especialmente relevante cuando el código fuente no está disponible, lo que obliga al analista a estudiar
directamente el binario ejecutable, combinando técnicas de análisis estático y dinámico. Con el primero se inspecciona el binario, identificando funciones, estructuras, rutas de ejecución y patrones sospechosos. Mientras que con el segundo se ejecuta el
programa en un entorno controlado y se observa su comportamiento en tiempo real utilizando debuggers y depuradores. La combinación de ambos análisis lo que permite es comprender cómo se comporta el software ante determinadas entradas, cómo gestiona
la memoria y qué validaciones aplica o no aplica. La ingeniería inversa, como se ha mencionado, no se limita a entender cómo funciona un programa. También es una técnica muy eficaz para descubrir fallos de seguridad, especialmente cuando se parte de una hipótesis razonable o de un input que provoca un comportamiento anómalo. Siguiendo la propagación de una variable, inspeccionando el contenido de los registros o analizando qué funciones se invocan a partir de una entrada concreta, es posible detectar condiciones peligrosas como saltos condicionales manipulables, llamadas a funciones inseguras o errores lógicos críticos."*.

## Guía de instalación

### <ins>Setup</ins>
Utilizaremos el siguiente arsenal de herramientas:

- Immunity Debugger
- Mona
- Ida
- Server Vulnerable
- Python
- Nmap
- Visual Studio Code

Para facilitar la instalación lo realizaré en un ambiente Windows pero las herramientas mencionadas también pueden utilizarse sobre ambiente Linux.

### Paso a paso y explicación de cada herramienta

### Server vulnerable: este es un binario que ha sido diseñado para ser vulnerable, el cual se puede explotar. Para descargarlo puedes ir a:
[Download Vuln_Server](https://github.com/stephenbradshaw/vulnserver)

(captura de pantalla)
<img width="1219" height="520" alt="Vuln_server_download" src="https://github.com/user-attachments/assets/8fae2958-16b2-405a-b752-c0bd71f9b83c" />

### Python 3 para Windows: descargaremos el instalador que nos será útil también para la instalación de Immunity Debugger. Para descargarlo os dejo la ruta al instalador x64: [Pinchar aquí](https://www.python.org/ftp/python/3.13.9/python-3.13.9-amd64.exe)

Luego agregas el "path" y le dices "install now"!!

<img width="645" height="399" alt="Python 1" src="https://github.com/user-attachments/assets/0673499a-19b1-4339-a4ae-6edd25a5169e" />


### Immunity Debugger: esta herramienta analiza el binario para poder encontrar vulnerabilidades (hace debugging) y luego explotar la misma. Para descargarlo puedes ir a:
[Descarga](https://github.com/kbandla/ImmunityDebugger/releases)

<img width="1022" height="394" alt="Immunity download" src="https://github.com/user-attachments/assets/b4386ccc-78ee-4577-9a08-9b4425ea2456" />


La instalación la comienzas aceptando el acuerdo y al darle instalar comienza a extraer los archivos necesarios para comenzar la instalación.

<img width="416" height="282" alt="Immu 1" src="https://github.com/user-attachments/assets/84555402-04a0-4796-9e45-df50d6f65514" />


Luego, te preguntará si deseas instalar Python 2.7, puedes decirle que si por si luego deseas probar algunos scripts en Python 2 también. Al finalizar, deberías tener el programa instalado y buscarlo en tus nuevas instalaciones. Al ejecutarlo se ve así:

<img width="1913" height="1032" alt="Immu 2" src="https://github.com/user-attachments/assets/666bc87d-b852-45cc-ab33-a88d4cb345e5" />


### IDA: También es un debugger pero tiene un apartado para ver un pseudo código de lo que es el ensamblador. Con esta herramienta podemoes efectuar ingeniería inversa. Para descargarlo puedes ir a:
[Descarga](https://github.com/TheMalwareGuardian/Exploit-the-Binary/blob/main/Installers/mona-master-x64dbg.zip)

Luego de descomprimirlo, lo ejecutamos y seguimos los pasos (siguiente, siguiente) hasta finalizar su instalación. Al abrirlo ejecutamos "new file":

<img width="393" height="353" alt="ida1" src="https://github.com/user-attachments/assets/495b013e-77c1-48e8-9521-61b7f1df41be" />


Allí iremos a buscar nuestro binario vulnerable:

<img width="772" height="537" alt="ida2" src="https://github.com/user-attachments/assets/61bd9b4b-23ef-418d-babb-2243120c371f" />


Aceptamos:

<img width="734" height="550" alt="ida3" src="https://github.com/user-attachments/assets/35bc7bd3-31dc-4bfc-81ac-b3ef0719b5ad" />


Y por último, veremos las funciones del lado izquierdo y del derecho el ensamblador (luego lo veremos en la explotación más adelante)

<img width="1191" height="698" alt="ida4" src="https://github.com/user-attachments/assets/cf439c45-8bb8-4673-8e74-da5e6028bcdc" />


### Mona: esta es una herramienta que podemos importar en Immunity para facilitarnos la explotación en el binario. Para descargarlo puedes ir a:
[Descarga](https://github.com/TheMalwareGuardian/Exploit-the-Binary/blob/main/Installers/mona-master-corelan.zip)


Al descargarlo y descomprimirlo, veremos lo siguiente:

<img width="523" height="246" alt="mona 1" src="https://github.com/user-attachments/assets/976a8124-5930-4ed0-a7a6-979047a8ab74" />


Ya podemos observar que ese .py de Python ha sido reconocido porque previamente lo instalamos. Ese mismo archivo debemos copiarme dentro del siguiente folder "C:\Program Files (x86)\Immunity Inc\Immunity Debugger\PyCommands\" para que luego desde Immunity nos permita ejecutarlo.

<img width="1150" height="1011" alt="mona 2" src="https://github.com/user-attachments/assets/03aba7b8-0ea3-4bf8-9f0c-9305e67cf91c" />

Como podemos observar en la imagen previa, ejecutamos "!mona" y nos reconoce el comando.

### Nmap para Windows: esto nos permitirá consultar al servidor vulnerable que estará escuchando las conexiones entrantes al puerto 9999 con el ncat (más allá de poder usar nmap para ver que puertos tiene abiertos un destino). Lo podemos descargar de aquí:
[Descarga](https://nmap.org/dist/nmap-7.98-setup.exe)

Seleccionamos "npcap" dentro de las opciones (sino viene instalado) y luego es por defecto, siguiente y siguiente hasta terminar la instalación.

Aquí ya vemos como quedó instalado (luego usaremos el comando para generar una consulta al server vulnerable):

<img width="639" height="247" alt="ncat" src="https://github.com/user-attachments/assets/e42a5327-dd07-4b11-876a-32e04a739113" />


### Visual Studio Code: esta herramienta nos permitirá ver código y también sripts de Python y demás. Para descargarlo para Windows:
[Descarga](https://code.visualstudio.com/sha/download?build=stable&os=win32-x64-user)

Es sencilla la instalación, apretamos siguiente e instalar.

<img width="592" height="457" alt="vscode1" src="https://github.com/user-attachments/assets/2e399a0b-f211-4d28-a81d-329ea1baeb8a" />

Luego vamos a abrir la carpeta en donde descargaremos scripts.

<img width="553" height="461" alt="vscode2" src="https://github.com/user-attachments/assets/5aca876f-c1f9-4405-a2d5-12d01012aa5f" />
<img width="378" height="268" alt="imagen" src="https://github.com/user-attachments/assets/4acff24e-e0a1-4930-89f4-7788170afd1f" />


## Explotación

Vamos a comenzar descargando dos scripts que nos permitirán conectarnos al server vulnerable y luego hacer fuzzing y evidenciar como podemos lograr colgar el servidor, dado que inicialmente conocemos una de sus vulnerabilidades para efectuar un buffer overflow. Luego de efectuar esto, haremos el paso a paso de como sería con Immunity y demás herramientas, acercándonos a una prueba en un ambiente más real donde habitualmente no tendríamos el código fuente para analizarlo y deberíamos utilizar estas herramientas y analizar pseudo código.

1. Vamos a ejecutar el binario para levantar el servicio. Para ello, primero, voy a dejar una captura de mi folder con todo dentro para que sirva de guía. Cada uno tendra el "Path" que haya elegido para efectuar este paso a paso.

<img width="260" height="236" alt="herramientas" src="https://github.com/user-attachments/assets/71ed126c-9409-4a3d-a7c5-238f9cb48a12" />

Ahora sí, abrimos una línea de comando (cmd) y ejecutamos el binario:

<img width="904" height="287" alt="vulnserver" src="https://github.com/user-attachments/assets/2341d8eb-49a5-4b8c-b427-39bcd8e46bcc" />

2. Con el servicio levantado, vamos a descargarnos dos scripts en python. Pueden descargarlo desde [aquí](https://github.com/TheMalwareGuardian/Exploit-the-Binary/tree/main/Vulnerable%20Binaries/Windows/01%20Vulnserver/Methodology%20%26%20Exploitation/01%20Stack%20Buffer%20Overflow/Exploit): descargar solo los marcados en rojo

<img width="1214" height="514" alt="descarga de scripts" src="https://github.com/user-attachments/assets/2a622776-7d32-43cb-9337-fe2c00e79308" />

Veamos con Visual Studio Code el primer Script, el de conección:

<img width="898" height="466" alt="script 1" src="https://github.com/user-attachments/assets/a0214cb3-b9e5-40ab-a713-738442eb04d7" />

Claramente vemos como el script se conectará al server (en este caso es la IP 127.0.0.1 que es la propia IP de uno o el propio localhost) y enviará el comando "Help".

Ejecutémoslo y vemos la salida exitosa:

<img width="1524" height="985" alt="script1-2" src="https://github.com/user-attachments/assets/482093b2-f77d-4b29-9a4e-d68af9bcbf83" />

Lo mismo podemos hacer desde una terminal CMD con el ncat que nos bajamos antes!!

<img width="890" height="552" alt="script1-3" src="https://github.com/user-attachments/assets/53031175-ced4-4420-80ae-754a8cba4bdc" />

Finalmente, pasemos al segundo script que es el de fuzzing:

<img width="744" height="352" alt="script2" src="https://github.com/user-attachments/assets/acdcc5e8-6212-41e3-b7b2-cd313f78af41" />

En el script podemos ver que se van a insertar varios parámetros (en este caso caracteres "A" incrementando el número) a la entrada del parámetro TRUN.

Vamos a ejecutarlo y ver como cuelga al programa, haciendo que este en un momento deje de responder!!!

<img width="1512" height="776" alt="script2-1" src="https://github.com/user-attachments/assets/323396a6-e066-4833-95f0-64f300071edc" />
<img width="798" height="380" alt="script2-2" src="https://github.com/user-attachments/assets/ff24346b-8c23-4a01-80dd-e36b7c9348d0" />

